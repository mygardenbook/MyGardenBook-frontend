<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Admin - Fishes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&family=Kalam:wght@700&display=swap" rel="stylesheet">

<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    min-height: 100vh;
    font-family: 'Baloo 2','Kalam','Arial',sans-serif;
    overflow-x: hidden;
  }

  .background-overlay {
    position: fixed;
    inset: 0;
    background: url('Bg.png') no-repeat center center fixed;
    background-size: cover;
    z-index: 0;
  }
  .background-overlay::after {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,0.72);
  }

  .content {
    position: relative;
    z-index: 2;
    padding-top: 4rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .nav-row {
    display: flex;
    justify-content: space-between;
    width: 94%;
    max-width: 860px;
  }

  .back-arrow {
    background: none;
    border: none;
    width: 34px;
    height: 34px;
    cursor: pointer;
  }

  .plants-btn, .action-btn {
    background: #BFE7BC;
    border: none;
    border-radius: 20px;
    padding: 0.7rem 1.3rem;
    font-weight: bold;
    cursor: pointer;
  }

  .actions-row {
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
    margin: 2rem 0 1rem;
  }

  .fish-list {
    display: grid;
    grid-template-columns: repeat(2,1fr);
    gap: 1rem;
    width: 90%;
    max-width: 650px;
    margin-bottom: 3rem;
  }

  .fish-card {
    background: #BFE7BC;
    border-radius: 18px;
    padding: 0.6rem;
    height: 145px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: 0.15s;
  }

  .fish-card.selected {
    outline: 3px solid #4A771C;
    background: #aee6a8;
  }

  .fish-img {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    border: 2px solid #4A771C;
    object-fit: cover;
    background: #fff;
  }

  .fish-name {
    font-size: 0.95rem;
    text-align: center;
  }

  .qr-btn {
    font-size: 0.75rem;
    background: #4A771C;
    color: #fff;
    border-radius: 12px;
    padding: 4px 10px;
    text-decoration: none;
  }

  .status-msg {
    min-height: 1em;
    margin-bottom: 1rem;
    font-size: 0.95rem;
    color: #1d6d25;
  }
</style>
</head>

<body>

<div class="background-overlay"></div>

<div class="content">

  <div class="nav-row">
    <button class="back-arrow" onclick="location.href='Admin.html'">â—€</button>
    <button class="plants-btn" onclick="location.href='AdminPlants.html'">Plants</button>
  </div>

  <div class="actions-row">
    <button class="action-btn" onclick="location.href='AdminFishCategories.html'">Categories</button>
    <button class="action-btn" onclick="location.href='AdminAddEditFish.html'">Add Fish</button>
    <button class="action-btn" id="deleteBtn">Delete Fish</button>
  </div>

  <div class="status-msg" id="statusMsg"></div>
  <div class="fish-list" id="fishList"></div>

</div>

<script>
const API_BASE = "https://mygardenbook-backend.onrender.com";
const token = localStorage.getItem("sb_token");

let deleteMode = false;
let selectedIds = [];

const listEl = document.getElementById("fishList");
const deleteBtn = document.getElementById("deleteBtn");
const statusMsg = document.getElementById("statusMsg");

function showMessage(msg, error=false) {
  statusMsg.textContent = msg;
  statusMsg.style.color = error ? "#b22222" : "#1d6d25";
  setTimeout(() => statusMsg.textContent = "", 2500);
}

async function loadFishes() {
  const res = await fetch(`${API_BASE}/api/fishes`);
  const fishes = await res.json();
  render(fishes);
}

function render(fishes) {
  listEl.innerHTML = "";

  fishes.forEach(f => {
    const card = document.createElement("div");
    card.className = "fish-card";
    if (selectedIds.includes(f.id)) card.classList.add("selected");

    let qrHtml = "";
    if (f.qr_code_url) {
      qrHtml =
        '<a class="qr-btn" href="' +
        f.qr_code_url +
        '" download onclick="event.stopPropagation()">QR</a>';
    }

    card.innerHTML =
      '<img src="' + (f.image_url || "placeholder.jpg") + '" class="fish-img">' +
      '<div class="fish-name">' + f.name + "</div>" +
      qrHtml;

    card.onclick = () => {
      if (!deleteMode) {
        location.href = `AdminAddEditFish.html?id=${f.id}`;
        return;
      }

      if (selectedIds.includes(f.id)) {
        selectedIds = selectedIds.filter(x => x !== f.id);
      } else {
        selectedIds.push(f.id);
      }

      render(fishes);
      deleteBtn.textContent = `Confirm Delete (${selectedIds.length})`;
    };

    listEl.appendChild(card);
  });
}


deleteBtn.onclick = async () => {
  if (!deleteMode) {
    deleteMode = true;
    deleteBtn.textContent = "Confirm Delete (0)";
    deleteBtn.style.background = "#E57373";
    showMessage("Select fishes to delete");
    return;
  }

  if (!selectedIds.length) {
    showMessage("No fish selected", true);
    resetDelete();
    return;
  }

  for (const id of selectedIds) {
    await fetch(`${API_BASE}/api/fishes/${id}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` }
    });
  }

  showMessage(`${selectedIds.length} fishes deleted`);
  resetDelete();
  loadFishes();
};

function resetDelete() {
  deleteMode = false;
  selectedIds = [];
  deleteBtn.textContent = "Delete Fish";
  deleteBtn.style.background = "#BFE7BC";
}

loadFishes();
</script>

<script src="/js/config.js"></script>
</body>
</html>
