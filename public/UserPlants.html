<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plants</title>

<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&family=Kalam:wght@700&display=swap" rel="stylesheet">

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Baloo 2','Kalam',sans-serif;
    background: url('Bg.png') no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
    position: relative;
  }

  body::before {
    content:"";
    position:fixed;
    inset:0;
    background:rgba(255,255,255,0.7);
    z-index:0;
  }

  .content {
    position: relative;
    z-index: 5;
    padding-top: 3.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .back-arrow {
    position: fixed;
    top: 16px;
    left: 16px;
    width: 34px;
    height: 34px;
    border: none;
    background: none;
    cursor: pointer;
    z-index: 10;
  }

  .search-wrap {
    width: 90%;
    max-width: 600px;
    margin: 1rem auto 2rem auto;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  .search-box, .filter-box {
    display: flex;
    align-items: center;
    background: #fff;
    padding: 0.7rem 1rem;
    border-radius: 25px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .search-box input,
  .filter-box select {
    border: none;
    outline: none;
    width: 100%;
    font-size: 1rem;
    background: none;
    margin-left: 8px;
    font-family: inherit;
  }

  .grid {
    width: 90%;
    max-width: 700px;
    display: grid;
    grid-template-columns: repeat(2,1fr);
    gap: 1rem;
    margin-bottom: 2.5rem;
  }

  .card {
    background:#BFE7BC;
    padding: 0.7rem;
    border-radius: 18px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    text-align:center;
    cursor:pointer;
    transition: transform .15s ease;
  }

  .card:hover { transform: scale(1.04); }

  .card img {
    width: 70px;
    height: 70px;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid #4A771C;
  }

  .card-name {
    margin-top: 0.5rem;
    font-size: 1.05rem;
    color: #1A2B10;
  }

  @media (max-width:600px) {
    .grid { gap: 0.8rem; }
    .card img { width: 64px; height: 64px; }
  }
</style>
</head>

<body>

<button class="back-arrow" onclick="window.location.href='User.html'">
  <svg viewBox="0 0 30 30" width="100%" height="100%">
    <polyline points="20,6 10,15 20,24"
              fill="none" stroke="#262A23" stroke-width="4"
              stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

<div class="content">

  <div class="search-wrap">

    <!-- SEARCH -->
    <div class="search-box">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <circle cx="10" cy="10" r="7" stroke="#4A771C" stroke-width="2" fill="none"/>
        <line x1="15" y1="15" x2="20" y2="20" stroke="#4A771C" stroke-width="2"/>
      </svg>
      <input id="searchInput" placeholder="Search plants..." oninput="applyFilters()">
    </div>

    <!-- CATEGORY FILTER -->
    <div class="filter-box">
      <select id="categoryFilter" onchange="applyFilters()">
        <option value="">All Categories</option>
      </select>
    </div>

    <!-- SORT -->
    <div class="filter-box">
      <select id="sortSelect" onchange="applyFilters()">
        <option value="recent">Recently Added</option>
        <option value="az">Name A → Z</option>
        <option value="za">Name Z → A</option>
      </select>
    </div>

  </div>

  <div class="grid" id="plantGrid"></div>
</div>

<script>
const API_BASE = "https://mygardenbook-backend.onrender.com";
const PAGE_SIZE = 12;

let allPlants = [];
let filteredList = [];
let currentIndex = 0;
let isLoadingMore = false;

function pick(...values) {
  return values.find(v => v !== undefined && v !== null && String(v).trim() !== "") || "";
}

function resolveImg(src) {
  if (!src) return null;
  if (src.startsWith("http")) return src;
  if (src.startsWith("/")) return API_BASE + src;
  return src;
}

function plantId(p) {
  return pick(p.id, p._id, p.plantId, p.plant_id);
}

/* ---------------- LOAD CATEGORIES ---------------- */
async function loadCategories() {
  const res = await fetch(`${API_BASE}/api/categories`);
  const cats = await res.json();
  const sel = document.getElementById("categoryFilter");

  cats.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.name;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
}

/* ---------------- LOAD DATA ---------------- */
async function loadPlants() {
  const res = await fetch(`${API_BASE}/api/plants`);
  allPlants = await res.json();
  applyFilters();
}

/* ---------------- FILTER + SORT ---------------- */
function applyFilters() {
  const q = document.getElementById("searchInput").value.toLowerCase();
  const cat = document.getElementById("categoryFilter").value;
  const sort = document.getElementById("sortSelect").value;

  filteredList = [...allPlants];

  filteredList = filteredList.filter(p =>
    pick(p.name, p.commonName, p.scientific_name).toLowerCase().includes(q) ||
    pick(p.category).toLowerCase().includes(q)
  );

  if (cat) {
    filteredList = filteredList.filter(p => pick(p.category) === cat);
  }

  if (sort === "az") {
    filteredList.sort((a,b) =>
      pick(a.name, a.commonName).localeCompare(pick(b.name, b.commonName))
    );
  } else if (sort === "za") {
    filteredList.sort((a,b) =>
      pick(b.name, b.commonName).localeCompare(pick(a.name, a.commonName))
    );
  } else {
    filteredList.sort((a,b) => plantId(b) - plantId(a));
  }

  resetAndRender();
}

/* ---------------- PAGINATION ---------------- */
function resetAndRender() {
  currentIndex = 0;
  document.getElementById("plantGrid").innerHTML = "";
  loadMore();
}

function loadMore() {
  if (isLoadingMore) return;
  isLoadingMore = true;

  const nextItems = filteredList.slice(currentIndex, currentIndex + PAGE_SIZE);
  currentIndex += PAGE_SIZE;

  renderPlants(nextItems);
  isLoadingMore = false;
}

/* ---------------- RENDER ---------------- */
function renderPlants(plants) {
  const grid = document.getElementById("plantGrid");

  if (!grid.children.length && !plants.length) {
    grid.innerHTML = "<p>No plants found.</p>";
    return;
  }

  plants.forEach(p => {
    const img = resolveImg(pick(p.image_url, p.image));
    const name = pick(p.name, p.commonName, p.scientific_name) || "Unknown";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img src="${img || 'placeholder.jpg'}">
      <div class="card-name">${name}</div>
    `;
    card.onclick = () =>
      window.location.href = `UserEachPlant.html?id=${encodeURIComponent(plantId(p))}`;

    grid.appendChild(card);
  });
}

/* ---------------- SCROLL LISTENER ---------------- */
window.addEventListener("scroll", () => {
  if (
    window.innerHeight + window.scrollY >=
    document.body.offsetHeight - 300
  ) {
    loadMore();
  }
});

/* ---------------- INIT ---------------- */
loadCategories();
loadPlants();
</script>


<script src="/js/config.js"></script>

</body>
</html>
