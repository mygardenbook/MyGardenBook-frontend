<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login / Signup - My Garden Book</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&family=Kalam:wght@700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Baloo 2','Kalam',sans-serif;
      background: url('Bg.png') no-repeat center center fixed;
      background-size: cover;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      position:relative;
    }
    body::before{
      content:""; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(255,255,255,0.7); z-index:0;
    }
    .card {
      z-index:2; width:92%; max-width:420px; background:rgba(143,216,113,0.45);
      padding:1.6rem 1.8rem; border-radius:18px; box-shadow:0 8px 30px rgba(0,0,0,0.12);
    }
    .title { text-align:center; font-size:1.6rem; font-weight:700; margin-bottom:12px; color:#204d1e; }
    .tabs { display:flex; gap:8px; margin-bottom:12px; }
    .tab {
      cursor:pointer; flex:1; padding:8px 10px; border-radius:12px;
      text-align:center; font-weight:600; background:#d7efce; transition:0.18s;
    }
    .tab.active { background:#BFE7BC; color:#1A2B10; box-shadow:0 3px 10px rgba(0,0,0,0.12); }
    .forms { width:200%; display:flex; transition:transform 0.28s ease; }
    form { width:50%; display:flex; flex-direction:column; gap:10px; }
    input { border-radius:10px; border:2px solid #66A03A; padding:10px 12px; font-size:1rem; background:white; outline:none; }
    .btn { background:#BFE7BC; border:none; padding:10px; border-radius:12px; font-size:1.05rem; cursor:pointer; font-weight:600; }
    .btn:hover { background:#b3e572; }
    .helper { font-size:0.95rem; color:#2e7d32; text-align:center; margin-top:8px; min-height:1.1rem; }
    .small { font-size:0.9rem; color:#27421b; text-align:center; margin-top:8px; }
    .sep { height:10px; }
    .admin-note { font-size:0.9rem; color:#333; text-align:center; margin-top:10px; }
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="cardTitle">
    <div id="cardTitle" class="title">My Garden Book</div>

    <div class="tabs" role="tablist" aria-label="Auth tabs">
      <div id="userTab" class="tab active" role="tab" aria-selected="true">User Login / Signup</div>
      <div id="adminTab" class="tab" role="tab" aria-selected="false">Admin Login</div>
    </div>

    <div style="overflow:hidden;">
      <div class="forms" id="formSlider">

        <!-- USER UI (left half) -->
        <div style="padding-right:12px;">
          <!-- Toggle: Login vs Signup inside user tab -->
          <div style="display:flex; gap:8px; margin-bottom:10px;">
            <button id="uLoginBtn" class="tab active" style="flex:1;">Login</button>
            <button id="uSignupBtn" class="tab" style="flex:1;">Sign up</button>
          </div>

          <!-- USER LOGIN FORM -->
          <form id="userLoginForm" aria-label="User login form">
            <input id="userLoginEmail" type="email" placeholder="Email" required />
            <input id="userLoginPass" type="password" placeholder="Password" required />
            <button class="btn" type="submit">Login</button>
            <div id="userLoginMsg" class="helper" role="status" aria-live="polite"></div>
          </form>

          <!-- USER SIGNUP FORM -->
          <form id="userSignupForm" style="display:none;" aria-label="User signup form">
            <input id="userSignupEmail" type="email" placeholder="Email" required />
            <input id="userSignupPass" type="password" placeholder="Create password" required />
            <input id="userSignupConfirm" type="password" placeholder="Confirm password" required />
            <button class="btn" type="submit">Create account</button>
            <div id="userSignupMsg" class="helper" role="status" aria-live="polite"></div>
          </form>

          <div class="sep"></div>
          <div class="small">Users authenticated via <strong>Supabase Auth (email/password)</strong>.</div>
        </div>

        <!-- ADMIN UI (right half) -->
        <div style="padding-left:12px;">
          <form id="adminLoginForm" aria-label="Admin login form">
            <input id="adminEmail" type="email" placeholder="Admin email" required />
            <input id="adminPass" type="password" placeholder="Admin password" required />
            <button class="btn" type="submit">Admin Login</button>
            <div id="adminMsg" class="helper" role="status" aria-live="polite"></div>
          </form>

          <div class="sep"></div>
          <div class="admin-note">Admin accounts are handled by your backend (keeps admin_table & hashes).</div>
        </div>

      </div>
    </div>

    <div class="small" style="margin-top:12px; text-align:center; color:#444;">
      Need account verification or password reset? Use Supabase Dashboard (Auth → Settings).
    </div>
  </div>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>

  <script>
    /***********************
     *  CONFIG - replace these
     *  or inject via environment during deployment
     ***********************/
    const SUPABASE_URL = "https://ctoqycjzmfvdvgnirlkp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0b3F5Y2p6bWZ2ZHZnbmlybGtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNDUyOTIsImV4cCI6MjA3OTkyMTI5Mn0.Gd3gHxbypxTKpyweLFwQvriIeX2lF1QTTRSMDfpXbqI";
    const BACKEND_BASE = "https://mygardenbook-backend.onrender.com"; // adjust if needed

    // initialize supabase client
    const supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * UI wiring
     ***********************/
    const userTab = document.getElementById("userTab");
    const adminTab = document.getElementById("adminTab");
    const formSlider = document.getElementById("formSlider");

    userTab.onclick = () => {
      userTab.classList.add("active");
      adminTab.classList.remove("active");
      // show left half
      formSlider.style.transform = "translateX(0%)";
      userTab.setAttribute("aria-selected","true");
      adminTab.setAttribute("aria-selected","false");
    };
    adminTab.onclick = () => {
      adminTab.classList.add("active");
      userTab.classList.remove("active");
      // slide to right half
      formSlider.style.transform = "translateX(-50%)";
      userTab.setAttribute("aria-selected","false");
      adminTab.setAttribute("aria-selected","true");
    };

    // inside user: toggle Login vs Signup panels
    const uLoginBtn = document.getElementById("uLoginBtn");
    const uSignupBtn = document.getElementById("uSignupBtn");
    const userLoginForm = document.getElementById("userLoginForm");
    const userSignupForm = document.getElementById("userSignupForm");
    const userLoginMsg = document.getElementById("userLoginMsg");
    const userSignupMsg = document.getElementById("userSignupMsg");

    uLoginBtn.onclick = () => {
      uLoginBtn.classList.add("active"); uSignupBtn.classList.remove("active");
      userLoginForm.style.display = "flex"; userSignupForm.style.display = "none";
      userLoginMsg.textContent = "";
      userSignupMsg.textContent = "";
    };
    uSignupBtn.onclick = () => {
      uSignupBtn.classList.add("active"); uLoginBtn.classList.remove("active");
      userLoginForm.style.display = "none"; userSignupForm.style.display = "flex";
      userLoginMsg.textContent = "";
      userSignupMsg.textContent = "";
    };

    /***********************
     * USER: login via Supabase
     ***********************/
    document.getElementById("userLoginForm").onsubmit = async (e) => {
      e.preventDefault();
      userLoginMsg.style.color = "#1A2B10"; userLoginMsg.textContent = "Signing in...";
      const email = document.getElementById("userLoginEmail").value.trim();
      const password = document.getElementById("userLoginPass").value.trim();

      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          userLoginMsg.style.color = "#c62828";
          userLoginMsg.textContent = error.message || "Login failed";
          return;
        }
        // success: store session (we store user.id and token minimally)
        // supabase stores session internally but we save useful bits for front-end routing
        localStorage.setItem("mg_user_id", data.user?.id || "");
        // redirect user to user menu / dashboard
        userLoginMsg.style.color = "#2e7d32";
        userLoginMsg.textContent = "Login successful — redirecting...";
        setTimeout(() => window.location.href = "User.html", 700);
      } catch (err) {
        console.error(err);
        userLoginMsg.style.color = "#c62828";
        userLoginMsg.textContent = "Server error";
      }
    };

    /***********************
     * USER: signup via Supabase
     ***********************/
    document.getElementById("userSignupForm").onsubmit = async (e) => {
      e.preventDefault();
      userSignupMsg.style.color = "#1A2B10"; userSignupMsg.textContent = "Creating account...";
      const email = document.getElementById("userSignupEmail").value.trim();
      const pass = document.getElementById("userSignupPass").value.trim();
      const confirm = document.getElementById("userSignupConfirm").value.trim();

      if (pass !== confirm) {
        userSignupMsg.style.color = "#c62828";
        userSignupMsg.textContent = "Passwords do not match";
        return;
      }
      try {
        const { data, error } = await supabase.auth.signUp({ email, password: pass }, { data: { source: "web" } });
        if (error) {
          userSignupMsg.style.color = "#c62828";
          userSignupMsg.textContent = error.message || "Signup failed";
          return;
        }
        userSignupMsg.style.color = "#2e7d32";
        userSignupMsg.textContent = "Account created. Check your email for confirmation (if enabled). Please log in.";
        // automatically switch to login view
        uLoginBtn.click();
      } catch (err) {
        console.error(err);
        userSignupMsg.style.color = "#c62828";
        userSignupMsg.textContent = "Server error";
      }
    };

    /***********************
     * ADMIN: login uses your backend /api/admin/login
     ***********************/
    document.getElementById("adminLoginForm").onsubmit = async (e) => {
      e.preventDefault();
      const msgEl = document.getElementById("adminMsg");
      msgEl.style.color = "#1A2B10"; msgEl.textContent = "Logging in...";
      const email = document.getElementById("adminEmail").value.trim();
      const password = document.getElementById("adminPass").value.trim();

      try {
        const res = await fetch(`${BACKEND_BASE}/api/admin/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        const json = await res.json();
        if (!res.ok) {
          msgEl.style.color = "#c62828";
          msgEl.textContent = json.error || "Admin login failed";
          return;
        }
        // backend returns token + admin info (per your admin.js)
        localStorage.setItem("admin_token", json.token);
        localStorage.setItem("admin_email", json.admin?.email || email);
        msgEl.style.color = "#2e7d32";
        msgEl.textContent = "Admin login successful — redirecting...";
        setTimeout(() => window.location.href = "Admin.html", 600);
      } catch (err) {
        console.error(err);
        msgEl.style.color = "#c62828";
        msgEl.textContent = "Server error";
      }
    };

    /***********************
     * Optional: check if user already logged in (persisted session)
     ***********************/
    (async function checkSession() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
          // user already signed in
          // redirect to user view
          // NOTE: you might want to refresh tokens or fetch profile before redirecting
          console.log("Supabase session found — redirecting to User.html");
          // small delay so user sees message if they opened the login page intentionally
          setTimeout(() => window.location.href = "User.html", 700);
        }
      } catch (err) {
        // ignore
      }
    })();

  </script>
  <script src="/js/config.js"></script>
</body>
</html>
