<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Fishes</title>

<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&family=Kalam:wght@700&display=swap" rel="stylesheet">

<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: 'Baloo 2','Kalam',sans-serif;
    background: url('Bg.png') no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
  }

  body::before {
    content:"";
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(255,255,255,0.7);
    z-index:0;
  }

  .content {
    z-index:5;
    position:relative;
    padding-top:4.2rem;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  .back-arrow {
    position:fixed;
    top:16px; left:16px;
    width:36px; height:36px;
    background:none; border:none;
    cursor:pointer; z-index:10;
  }

  /* Search bar */
  .search-wrap {
    width:90%; max-width:600px;
    margin:0.8rem auto 2rem auto;
  }

  .search-box {
    background:white;
    padding:0.7rem 1rem;
    display:flex;
    align-items:center;
    border-radius:22px;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
  }

  .search-box input {
    width:100%;
    border:none;
    outline:none;
    font-size:1rem;
    margin-left:8px;
    background:none;
  }

  .grid {
    width:90%;
    max-width:700px;
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:1.2rem;
    margin-bottom:2.5rem;
  }

  .card {
    background:#BFE7BC;
    padding:0.9rem;
    border-radius:18px;
    box-shadow:0 4px 10px rgba(0,0,0,0.15);
    text-align:center;
    cursor:pointer;
    transition:transform .15s ease;
  }

  .card:hover { transform:scale(1.05); }

  .card img {
    width:80px; height:80px;
    border-radius:14px;
    object-fit:cover;
    border:2px solid #4A771C;
  }

  .card-name {
    margin-top:0.6rem;
    font-size:1.05rem;
    color:#1A2B10;
  }

  @media(max-width:600px) {
    .card img { width:70px; height:70px; }
    .card { padding:0.75rem; }
  }
</style>

</head>

<body>

<button class="back-arrow" onclick="window.location.href='User.html'">
  <svg viewBox="0 0 30 30" width="100%" height="100%">
    <polyline points="20,6 10,15 20,24"
      fill="none" stroke="#262A23" stroke-width="4"
      stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

<div class="content">

  <!-- Search -->
  <div class="search-wrap">
    <div class="search-box">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <circle cx="10" cy="10" r="7" stroke="#4A771C" stroke-width="2" fill="none"/>
        <line x1="15" y1="15" x2="20" y2="20" stroke="#4A771C" stroke-width="2"/>
      </svg>
      <input id="fishSearch" placeholder="Search for a fish..." oninput="filterFishes()">
    </div>
  </div>

  <!-- Grid -->
  <div class="grid" id="fishGrid"></div>

</div>

<script>
  const API_BASE = "https://mygardenbook-backend.onrender.com";

  function pick(...values) {
    return values.find(v => v !== undefined && v !== null && String(v).trim() !== "") || null;
  }

  function resolveImg(src) {
    if (!src) return "placeholder.jpg";
    if (/^https?:\/\//.test(src)) return src;
    if (src.startsWith("/")) return API_BASE + src;
    return src;
  }

  function getId(obj) {
    return pick(obj.id, obj._id, obj.fishId, obj.fish_id);
  }

  async function loadFishes() {
    try {
      const res = await fetch(`${API_BASE}/api/fishes`);
      if (!res.ok) throw new Error("Fetch error");

      const fishes = await res.json();
      window.allFishes = fishes;
      renderFishes(fishes);
    } catch(err) {
      document.getElementById("fishGrid").innerHTML = "<p>Failed to load fishes.</p>";
    }
  }

  function renderFishes(fishes) {
    const grid = document.getElementById("fishGrid");
    grid.innerHTML = "";

    if (!fishes.length) {
      grid.innerHTML = "<p>No fishes found.</p>";
      return;
    }

    fishes.forEach(f => {
      const id = getId(f);
      const img = resolveImg(
        pick(f.image, f.image_url, f.imageUrl, f.img, f.photo)
      );

      const name = pick(f.name, f.commonName, f.scientific_name) || "Unknown";

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <img src="${img}">
        <div class="card-name">${name}</div>
      `;

      card.onclick = () => window.location.href = `UserEachFish.html?id=${encodeURIComponent(id)}`;
      grid.appendChild(card);
    });
  }

  function filterFishes() {
    const q = document.getElementById("fishSearch").value.toLowerCase();
    const filtered = window.allFishes.filter(f =>
      (pick(f.name, f.commonName, f.scientific_name) || "").toLowerCase().includes(q) ||
      (pick(f.category, f.category_name, f.categoryName) || "").toLowerCase().includes(q)
    );
    renderFishes(filtered);
  }

  loadFishes();
</script>

<script src="/js/config.js"></script>
</body>
</html>
